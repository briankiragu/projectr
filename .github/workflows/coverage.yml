name: Coverage

on:
  push:
  pull_request:

jobs:
  test:
    runs-on: ubuntu-latest

    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: "notify vercel"
        uses: "vercel/repository-dispatch/actions/status@v1"
        with:
          name: "Vercel - projectr: lint"

      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v3
        with:
          version: 8

      - name: Use Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: "pnpm"

      - name: "Install Dependencies"
        run: pnpm install

      - name: "Run Tests with Coverage"
        run: pnpm test:coverage

      - name: "Upload Coverage Artifact"
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage
          path: coverage/**
          if-no-files-found: warn

      - name: "Comment Coverage Summary"
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = 'coverage/coverage-summary.json';

            if (!fs.existsSync(path)) {
              core.warning(`Coverage summary not found at ${path}`);
              return;
            }

            const summary = JSON.parse(fs.readFileSync(path, 'utf8'));
            const total = summary.total || {};
            const pct = (x) => (x && typeof x.pct === 'number') ? x.pct : null;
            const lines = pct(total.lines);
            const statements = pct(total.statements);
            const functions = pct(total.functions);
            const branches = pct(total.branches);

            const marker = '<!-- vitest-coverage-summary -->';
            const fmt = (v) => (v === null ? 'n/a' : `${v.toFixed(2)}%`);
            const body = [
              marker,
              '## Coverage (Vitest)',
              '',
              `- Lines: ${fmt(lines)}`,
              `- Statements: ${fmt(statements)}`,
              `- Functions: ${fmt(functions)}`,
              `- Branches: ${fmt(branches)}`,
              '',
              '_Artifact: `coverage` (see workflow run)_',
            ].join('\n');

            const { owner, repo } = context.repo;
            const issue_number = context.payload.pull_request.number;

            const { data: comments } = await github.rest.issues.listComments({
              owner,
              repo,
              issue_number,
              per_page: 100,
            });

            const existing = comments.find(c =>
              c.user?.type === 'Bot' && typeof c.body === 'string' && c.body.includes(marker)
            );

            if (existing) {
              await github.rest.issues.updateComment({
                owner,
                repo,
                comment_id: existing.id,
                body,
              });
            } else {
              await github.rest.issues.createComment({
                owner,
                repo,
                issue_number,
                body,
              });
            }
